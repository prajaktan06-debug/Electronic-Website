<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ElectroMart - Cart</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="assets/css/professional.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .cart-summary-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .cart-summary-card h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 18px;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    
    .summary-row:last-child {
      border-bottom: none;
    }
    
    .total-row {
      border-top: 2px solid #e0e0e0;
      margin-top: 10px;
      padding-top: 15px;
      font-size: 16px;
    }
    
    .shipping-note {
      font-size: 11px;
      color: #666;
      font-style: italic;
      text-align: center;
      margin-top: 5px;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 10px;
      border: 1px solid #ffcdd2;
    }
    
    /* Professional Auth Button Styles */
    .login-btn:hover {
      background: rgba(255, 255, 255, 0.2) !important;
      border-color: rgba(255, 255, 255, 0.4) !important;
      transform: translateY(-1px);
    }
    
    .register-btn:hover {
      background: rgba(255, 255, 255, 0.3) !important;
      border-color: rgba(255, 255, 255, 0.5) !important;
      transform: translateY(-1px);
    }
    
    @media (max-width: 768px) {
      .cart.container > div:first-child {
        grid-template-columns: 1fr !important;
      }
      
      .checkout-form > div:first-child {
        grid-template-columns: 1fr !important;
      }
      
      .auth-buttons {
        margin-left: 0.5rem !important;
        gap: 0.5rem !important;
      }
      
      .login-btn, .register-btn {
        padding: 0.4rem 0.8rem !important;
        font-size: 0.9rem !important;
      }
    }
  </style>
</head>
<body>
  <!-- Professional Header -->
  <header class="professional-header" id="mainHeader">
    <div class="header-container">
      <div class="logo-section">
        <img src="assets/images/Logo.jpg" alt="ElectroMart Logo" class="logo">
        <div class="brand-text">ElectroMart</div>
      </div>
      
      <nav class="professional-nav">
        <ul class="nav-links">
          <li><a href="index.html">
            <i class="fas fa-home"></i>
            <span>Home</span>
          </a></li>
          <li><a href="products.html">
            <i class="fas fa-box"></i>
            <span>Products</span>
          </a></li>
          <li><a href="cart.html" class="active cart-link">
            <i class="fas fa-shopping-cart"></i>
            <span>Cart</span>
            <span class="cart-badge">0</span>
          </a></li>
          <li><a href="wishlist.html" class="wishlist-link">
            <i class="fas fa-heart"></i>
            <span>Wishlist</span>
            <span class="wishlist-badge">0</span>
          </a></li>
          <li><a href="About.html">
            <i class="fas fa-info-circle"></i>
            <span>About</span>
          </a></li>
          <li><a href="login.html" class="auth-link login-link">
            <i class="fas fa-sign-in-alt"></i>
            <span>Login</span>
          </a></li>
          <li><a href="register.html" class="auth-link register-link">
            <i class="fas fa-user-plus"></i>
            <span>Register</span>
          </a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Professional Cart -->
  <main class="professional-cart-container">
    <!-- Cart Header -->
    <div style="grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h1 style="margin: 0; color: var(--text-primary); font-size: 2.5rem; font-weight: 700;">ðŸ›’ Shopping Cart</h1>
      <button onclick="clearCart()" class="btn-danger">
        <i class="fas fa-trash" style="margin-right: 0.5rem;"></i>
        Clear Cart
      </button>
    </div>

    <!-- Cart Items Section -->
    <div class="cart-items-section">
      <p id="cart-empty-msg" style="text-align: center; color: var(--text-secondary); display: none; padding: 4rem 2rem; background: var(--background-tertiary); border-radius: var(--radius-xl); border: 2px dashed var(--border-color);">
        <i class="fas fa-shopping-cart" style="font-size: 3rem; color: var(--text-tertiary); margin-bottom: 1rem; display: block;"></i>
        <strong style="font-size: 1.25rem; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">Your cart is empty</strong>
        <span style="color: var(--text-secondary);">Add some products to get started</span><br>
        <a href="products.html" style="color: var(--primary-color); text-decoration: none; font-weight: 600; margin-top: 1rem; display: inline-block;">
          <i class="fas fa-arrow-right" style="margin-right: 0.5rem;"></i>
          Start Shopping
        </a>
      </p>

      <ul id="cart-items" style="list-style: none; padding: 0; margin: 0;"></ul>
    </div>

    <!-- Cart Summary Section -->
    <div class="cart-summary-section">
      <div id="cart-summary" style="display: none;">
        <!-- Cart summary will be populated by JavaScript -->
      </div>
      
      <!-- Order Limits Info -->
      <div class="shipping-info">
        <h4 style="margin: 0 0 1rem 0; color: var(--primary-color); font-size: 1rem; font-weight: 600;">
          <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
          Order Information
        </h4>
        <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
          <div style="margin-bottom: 0.5rem;"><strong>Max transaction:</strong> â‚¹50,000</div>
          <div style="margin-bottom: 0.5rem;"><strong>Max items per order:</strong> 10</div>
          <div style="margin-bottom: 0.5rem;"><strong>Min order amount:</strong> â‚¹1,000</div>
          <div><strong>Free shipping:</strong> Above â‚¹2,000</div>
        </div>
      </div>
      
      <!-- Place Order control -->
      <div class="cart-summary-card" style="margin-top:1rem;">
        <div class="checkout-actions" style="flex-direction:column; gap:10px;">
          <button class="btn-primary" style="background:#25D366" onclick="orderViaWhatsAppPro()">
            <i class="fab fa-whatsapp" style="margin-right:6px;"></i>
            Order via WhatsApp
          </button>
          <button class="btn-primary" style="background:#10b981" onclick="openPlaceOrderModalPro()">
            <i class="fas fa-check" style="margin-right:6px;"></i>
            Place Order
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Place Order Modal (Professional) -->
  <div id="place-order-modal-pro" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:12px; width:90%; max-width:720px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
        <h3 style="margin:0;">Review & Place Order</h3>
        <button class="btn-secondary" onclick="closePlaceOrderModalPro()">Close</button>
      </div>
      <div id="order-review-pro" style="max-height:300px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:12px; margin-bottom:12px;"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
        <div>
          <label class="form-label">Payment Method *</label>
          <div style="display:flex; flex-direction:column; gap:8px; margin-top:6px;">
            <label style="display:flex; align-items:center; gap:8px; padding:8px; border:2px solid #e5e7eb; border-radius:8px; cursor:pointer;">
              <input type="radio" name="paymentMethodPro" value="COD" checked>
              <span>Cash on Delivery (COD)</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; padding:8px; border:2px solid #e5e7eb; border-radius:8px; cursor:pointer;">
              <input type="radio" name="paymentMethodPro" value="UPI">
              <span>UPI Payment</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; padding:8px; border:2px solid #e5e7eb; border-radius:8px; cursor:pointer;">
              <input type="radio" name="paymentMethodPro" value="CARD">
              <span>Credit/Debit Card</span>
            </label>
          </div>
        </div>
        <div>
          <label class="form-label">Estimated Delivery</label>
          <div id="estimated-delivery-pro" style="margin-top:6px; font-weight:600;">â€”</div>
        </div>
      </div>
      
      <!-- Payment Details Section -->
      <div id="payment-details-section" style="display:none; margin-bottom:12px; padding:12px; background:#f8f9fa; border-radius:8px; border:1px solid #e5e7eb;">
        <label class="form-label">Payment Details *</label>
        <div id="upi-details" style="display:none; margin-top:8px;">
          <input type="text" id="upi-id" class="form-input" placeholder="Enter UPI ID (e.g., yourname@paytm)" style="margin-bottom:8px;">
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn-small" style="background:#00BAF2; color:#fff; padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">Paytm</button>
            <button type="button" class="btn-small" style="background:#5F259F; color:#fff; padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">PhonePe</button>
            <button type="button" class="btn-small" style="background:#4285F4; color:#fff; padding:6px 12px; border:none; border-radius:6px; cursor:pointer;">Google Pay</button>
          </div>
        </div>
        <div id="card-details" style="display:none; margin-top:8px;">
          <input type="text" id="card-number" class="form-input" placeholder="Card Number" style="margin-bottom:8px;" maxlength="19">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px;">
            <input type="text" id="card-expiry" class="form-input" placeholder="MM/YY" maxlength="5">
            <input type="text" id="card-cvv" class="form-input" placeholder="CVV" maxlength="3">
          </div>
          <input type="text" id="card-name" class="form-input" placeholder="Name on Card">
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:10px; margin:8px 0 16px 0;">
        <input type="checkbox" id="agree-terms-pro">
        <label for="agree-terms-pro">I agree to the Terms & Conditions and Return Policy</label>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <div style="font-size:18px; font-weight:700;">Payable: â‚¹<span id="payable-amount-pro">0</span></div>
        <button id="confirm-place-order-pro" type="button" class="btn-primary">
          <i class="fas fa-box" style="margin-right:6px;"></i>
          Confirm & Place Order
        </button>
      </div>
    </div>
  </div>

  <!-- Professional Checkout Form -->
  <div style="max-width: 1200px; margin: 0 auto; padding: 0 2rem;">
    <div class="order-summary-card" style="margin-top: 2rem;">
      <h3 style="text-align: center; margin-bottom: 2rem; color: var(--text-primary); font-size: 1.5rem; font-weight: 700;">
        <i class="fas fa-shipping-fast" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
        Delivery Information
      </h3>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-user" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
            Full Name *
          </label>
          <input type="text" id="customer-name" class="form-input" placeholder="Enter your full name" required />
        </div>
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-phone" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
            Phone Number *
          </label>
          <input type="tel" id="customer-phone" class="form-input" placeholder="10-digit mobile number" required />
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom: 2rem;">
        <label class="form-label">
          <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
          Delivery Address *
        </label>
        <textarea id="customer-address" class="form-input form-textarea" placeholder="Enter complete delivery address with landmark" required></textarea>
      </div>

      <!-- Professional WhatsApp Button -->
      <div style="text-align: center;">
        <a id="whatsapp-order-link" href="#" target="_blank" style="display:none;">
          <button class="btn-primary" style="background: linear-gradient(135deg, #25D366, #128C7E); padding: 1rem 2rem; font-size: 1.1rem;">
            <i class="fab fa-whatsapp" style="margin-right: 0.75rem; font-size: 1.2rem;"></i>
            Place Order via WhatsApp
          </button>
        </a>
      </div>
    </div>
  </div>
  </main>

  <!-- Professional Footer -->
  <footer class="professional-footer">
    <div class="footer-container">
      <div class="footer-section">
        <h3>ElectroMart</h3>
        <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1rem;">Your trusted partner for premium electronics and home appliances.</p>
        <div style="display: flex; gap: 1rem;">
          <a href="#" style="color: rgba(255, 255, 255, 0.8); font-size: 1.5rem;"><i class="fab fa-facebook"></i></a>
          <a href="#" style="color: rgba(255, 255, 255, 0.8); font-size: 1.5rem;"><i class="fab fa-twitter"></i></a>
          <a href="#" style="color: rgba(255, 255, 255, 0.8); font-size: 1.5rem;"><i class="fab fa-instagram"></i></a>
          <a href="#" style="color: rgba(255, 255, 255, 0.8); font-size: 1.5rem;"><i class="fab fa-youtube"></i></a>
        </div>
      </div>
      
      <div class="footer-section">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="products.html">Products</a></li>
          <li><a href="cart.html">Cart</a></li>
          <li><a href="About.html">About Us</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h3>Customer Service</h3>
        <ul>
          <li><a href="#">Contact Us</a></li>
          <li><a href="#">Shipping Info</a></li>
          <li><a href="#">Returns</a></li>
          <li><a href="#">FAQ</a></li>
        </ul>
      </div>
      
      <div class="footer-section">
        <h3>Contact Info</h3>
        <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 0.5rem;"><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>Kasara, Maharashtra</p>
        <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 0.5rem;"><i class="fas fa-phone" style="margin-right: 0.5rem;"></i>+91 8149549341</p>
        <p style="color: rgba(255, 255, 255, 0.8);"><i class="fas fa-envelope" style="margin-right: 0.5rem;"></i>info@electromart.com</p>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>&copy; 2025 ElectroMart. All rights reserved. | Privacy Policy | Terms of Service</p>
    </div>
  </footer>

  <!-- Professional JavaScript -->
  <script src="auth.js"></script>
  <script src="assets/js/SCR.JS"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  
  <script>
    // Unify header counts across storage formats
    function getUnifiedCart() {
      let cart = [];
      try {
        cart = JSON.parse(localStorage.getItem('cart') || '[]');
      } catch {}
      if (!Array.isArray(cart) || cart.length === 0) {
        try {
          const legacy = JSON.parse(localStorage.getItem('cartItems') || '[]');
          cart = Array.isArray(legacy) ? legacy.map(i => ({
            name: i.name, price: i.price, quantity: i.quantity || 1, image: i.image || ''
          })) : [];
        } catch {}
      }
      return cart;
    }

    function updateHeaderCounts() {
      const cart = getUnifiedCart();
      const totalItems = cart.reduce((s, i) => s + (i.quantity || 1), 0);
      document.querySelectorAll('.cart-badge, .cart-count').forEach(el => { el.textContent = totalItems; el.style.display = totalItems > 0 ? 'inline-block' : 'none'; });

      const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
      const wlCount = Array.isArray(wishlist) ? wishlist.length : 0;
      document.querySelectorAll('.wishlist-badge, #wishlistCount').forEach(el => { el.textContent = wlCount; el.style.display = wlCount > 0 ? 'inline-block' : 'none'; });
    }

    document.addEventListener('DOMContentLoaded', updateHeaderCounts);
    window.addEventListener('storage', updateHeaderCounts);

    // Compose WhatsApp order message from cart
    function orderViaWhatsAppPro() {
      const { cart, subtotal, gst, total } = getCartTotalsPro();
      if (cart.length === 0) {
        showNotification('Your cart is empty!', 'warning');
        return;
      }

      // Ensure latest delivery fields are captured
      persistDeliveryFromForm();
      const delivery = JSON.parse(localStorage.getItem('deliveryInfo') || '{}');
      let msg = '*ðŸ›’ New Order from ElectroMart*%0A%0A';
      msg += 'ðŸ“‹ *Items*%0A';
      cart.forEach((i, idx) => {
        const q = i.quantity || 1;
        msg += `${idx + 1}. ${i.name} Ã— ${q} - â‚¹${(i.price * q).toLocaleString()}%0A`;
      });
      msg += `%0ASubtotal: â‚¹${subtotal.toLocaleString()}%0A`;
      msg += `GST: â‚¹${gst.toLocaleString()}%0A`;
      msg += `*Total: â‚¹${total.toLocaleString()}*%0A%0A`;
      if (delivery && (delivery.fullName || delivery.phone || delivery.address)) {
        msg += 'ðŸ‘¤ *Customer*%0A';
        if (delivery.fullName) msg += `Name: ${delivery.fullName}%0A`;
        if (delivery.phone) msg += `Phone: ${delivery.phone}%0A`;
        if (delivery.address) msg += `Address: ${delivery.address}, ${delivery.city || ''} ${delivery.pincode || ''}%0A`;
        if (delivery.date || delivery.time) msg += `Preferred: ${delivery.date || ''} ${delivery.time || ''}%0A`;
      }

      const shopPhone = '918149549341'; // owner number in international format
      const url = `https://wa.me/${shopPhone}?text=${msg}`;
      window.open(url, '_blank');
    }

    // Persist delivery form fields to localStorage so WhatsApp flow includes them
    function persistDeliveryFromForm() {
      const fullName = document.getElementById('customer-name')?.value?.trim();
      const phone = document.getElementById('customer-phone')?.value?.trim();
      const address = document.getElementById('customer-address')?.value?.trim();
      if (!fullName && !phone && !address) return;
      const existing = JSON.parse(localStorage.getItem('deliveryInfo') || '{}');
      const info = { ...existing, fullName, phone, address };
      try { localStorage.setItem('deliveryInfo', JSON.stringify(info)); } catch {}
    }

    function prefillDeliveryForm() {
      try {
        const d = JSON.parse(localStorage.getItem('deliveryInfo') || '{}');
        if (d.fullName) document.getElementById('customer-name').value = d.fullName;
        if (d.phone) document.getElementById('customer-phone').value = d.phone;
        if (d.address) document.getElementById('customer-address').value = d.address;
      } catch {}
    }

    // Hook up listeners
    document.addEventListener('DOMContentLoaded', function() {
      prefillDeliveryForm();
      ['customer-name','customer-phone','customer-address'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('blur', persistDeliveryFromForm);
          el.addEventListener('input', function() {
            // lightweight debounce not necessary here
            persistDeliveryFromForm();
          });
        }
      });
    });
    // Professional header scroll effect
    window.addEventListener('scroll', function() {
      const header = document.getElementById('mainHeader');
      if (window.scrollY > 100) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });
    
    // Enhanced form validation
    document.addEventListener('DOMContentLoaded', function() {
      const formInputs = document.querySelectorAll('.form-input');
      
      formInputs.forEach(input => {
        input.addEventListener('focus', function() {
          this.style.borderColor = 'var(--primary-color)';
          this.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.1)';
        });
        
        input.addEventListener('blur', function() {
          this.style.borderColor = 'var(--border-color)';
          this.style.boxShadow = 'none';
        });
      });
    });
    
    // Professional loading states
    function showLoadingState(element) {
      const originalContent = element.innerHTML;
      element.innerHTML = '<div class="loading-spinner"></div> Processing...';
      element.disabled = true;
      
      return function hideLoadingState() {
        element.innerHTML = originalContent;
        element.disabled = false;
      };
    }
  </script>

  <!-- Place Order logic for professional cart -->
  <script>
    function getUnifiedCart() {
      // Prefer modern key 'cart'; fall back to legacy 'cartItems'
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (!Array.isArray(cart) || cart.length === 0) {
        const legacy = JSON.parse(localStorage.getItem('cartItems') || '[]');
        // normalize legacy items to common shape
        cart = legacy.map(i => ({
          name: i.name,
          price: i.price,
          quantity: i.quantity || 1,
          image: i.image || ''
        }));
      }
      return cart;
    }

    function getCartTotalsPro() {
      const cart = getUnifiedCart();
      const rawSubtotal = cart.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0);
      const discountPercent = 0; // coupons disabled
      const subtotal = rawSubtotal; // no discount applied
      const delivery = subtotal > 2000 ? 0 : 100;
      const gst = Math.round((subtotal + delivery) * 0.18);
      const total = subtotal + delivery + gst;
      return { cart, rawSubtotal, discountPercent, subtotal, delivery, gst, total };
    }


    function openPlaceOrderModalPro() {
      const { cart, subtotal, gst, total } = getCartTotalsPro();
      if (cart.length === 0) { showNotification('Your cart is empty!', 'error'); return; }
      const review = document.getElementById('order-review-pro');
      review.innerHTML = cart.map(i => `<div style="display:flex; justify-content:space-between; margin:6px 0;"><div>${i.name} Ã— ${i.quantity || 1}</div><div>â‚¹${(i.price * (i.quantity || 1)).toLocaleString()}</div></div>`).join('') +
        `<hr style='border:none; border-top:1px solid #eee; margin:10px 0;'/>`+
        `<div style='display:flex; justify-content:space-between;'><span>Subtotal</span><span>â‚¹${subtotal.toLocaleString()}</span></div>`+
        `<div style='display:flex; justify-content:space-between;'><span>GST</span><span>â‚¹${gst.toLocaleString()}</span></div>`+
        `<div style='display:flex; justify-content:space-between; font-weight:700;'><span>Total</span><span>â‚¹${total.toLocaleString()}</span></div>`;
      document.getElementById('payable-amount-pro').textContent = total.toLocaleString();
      const eta = new Date(); eta.setDate(eta.getDate() + 3);
      document.getElementById('estimated-delivery-pro').textContent = eta.toLocaleDateString('en-IN');
      
      // Setup payment method change handler
      document.querySelectorAll('input[name="paymentMethodPro"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const method = this.value;
          const detailsSection = document.getElementById('payment-details-section');
          const upiDetails = document.getElementById('upi-details');
          const cardDetails = document.getElementById('card-details');
          
          if (method === 'COD') {
            detailsSection.style.display = 'none';
          } else {
            detailsSection.style.display = 'block';
            if (method === 'UPI') {
              upiDetails.style.display = 'block';
              cardDetails.style.display = 'none';
            } else if (method === 'CARD') {
              upiDetails.style.display = 'none';
              cardDetails.style.display = 'block';
            }
          }
        });
      });
      
      const modalEl = document.getElementById('place-order-modal-pro');
      modalEl.style.display = 'flex';
      const confirmBtn = document.getElementById('confirm-place-order-pro');
      confirmBtn.disabled = false;
      // bind robustly
      confirmBtn.onclick = null;
      confirmBtn.addEventListener('click', confirmPlaceOrderPro, { once: true });
    }

    function closePlaceOrderModalPro() {
      document.getElementById('place-order-modal-pro').style.display = 'none';
    }

    function confirmPlaceOrderPro(event) {
      if (event) { event.preventDefault(); }
      const btn = document.getElementById('confirm-place-order-pro');
      if (btn) { btn.disabled = true; btn.style.opacity = '0.8'; }
      if (!document.getElementById('agree-terms-pro').checked) { showNotification('Please agree to the Terms to continue', 'warning'); if (btn) { btn.disabled = false; btn.style.opacity = '1'; } return; }
      const paymentMethod = document.querySelector('input[name="paymentMethodPro"]:checked')?.value || 'COD';
      
      // Validate payment details if needed
      if (paymentMethod === 'UPI') {
        const upiId = document.getElementById('upi-id')?.value?.trim();
        if (!upiId || !upiId.includes('@')) {
          showNotification('Please enter a valid UPI ID', 'error');
          if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
          return;
        }
      } else if (paymentMethod === 'CARD') {
        const cardNum = document.getElementById('card-number')?.value?.replace(/\s/g, '');
        const expiry = document.getElementById('card-expiry')?.value;
        const cvv = document.getElementById('card-cvv')?.value;
        const cardName = document.getElementById('card-name')?.value?.trim();
        if (!cardNum || cardNum.length < 16 || !expiry || !cvv || !cardName) {
          showNotification('Please fill all card details', 'error');
          if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
          return;
        }
      }
      
      const { cart, subtotal, gst, total } = getCartTotalsPro();
      const orderId = 'EM' + Date.now();
      const order = {
        id: orderId,
        createdAt: new Date().toISOString(),
        items: cart.map(i => ({ name: i.name, price: i.price, quantity: i.quantity || 1 })),
        totals: { subtotal, gst, final: total, discountPercent: 0 },
        delivery: JSON.parse(localStorage.getItem('deliveryInfo') || '{}'),
        paymentMethod,
        paymentDetails: paymentMethod === 'UPI' ? { upiId: document.getElementById('upi-id')?.value?.trim() } :
                        paymentMethod === 'CARD' ? {
                          cardNumber: document.getElementById('card-number')?.value?.replace(/\s/g, '').slice(-4),
                          expiry: document.getElementById('card-expiry')?.value,
                          cardName: document.getElementById('card-name')?.value?.trim()
                        } : {},
        status: 'placed'
      };
      try { localStorage.setItem('lastOrder', JSON.stringify(order)); } catch {}
      // clear both storage keys for consistency
      try { localStorage.removeItem('cart'); } catch {}
      try { localStorage.removeItem('cartItems'); } catch {}
      try { localStorage.removeItem('couponDiscount'); } catch {}
      try { updateCartBadge?.(); } catch {}
      
      // Send SMS confirmation
      sendOrderConfirmationSMS(order);
      
      closePlaceOrderModalPro();
      showNotification(`Order ${orderId} placed successfully! SMS confirmation sent.`, 'success');
      // Optional: navigate to a confirmation view if available
      setTimeout(() => {
        if (location.pathname.endsWith('cart.html')) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }, 300);
      if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
    }

    // Extra safety: delegate click if binding ever fails
    document.addEventListener('click', function(e) {
      const t = e.target.closest('#confirm-place-order-pro');
      if (t) {
        confirmPlaceOrderPro(e);
      }
    });

    // Send SMS confirmation for order
    async function sendOrderConfirmationSMS(order) {
      const phone = order.delivery?.phone || document.getElementById('customer-phone')?.value?.trim();
      if (!phone) {
        console.warn('No phone number available for SMS');
        return;
      }

      // Format phone for SMS
      let formattedPhone = phone.replace(/\D/g, '');
      if (formattedPhone.length === 10) {
        formattedPhone = '91' + formattedPhone; // Add India country code
      }

      // Generate SMS message
      const itemsList = order.items.map((item, idx) => 
        `${idx + 1}. ${item.name} (Qty: ${item.quantity})`
      ).join('%0A');

      const smsMessage = `ðŸŽ‰ Order Confirmed!%0A%0AOrder ID: ${order.id}%0ADate: ${new Date(order.createdAt).toLocaleDateString('en-IN')}%0A%0AItems:%0A${itemsList}%0A%0ATotal: â‚¹${order.totals.final.toLocaleString()}%0APayment: ${order.paymentMethod}%0A%0AThank you for shopping with ElectroMart!`;

      // Decode message for proper SMS format
      const decodedMessage = decodeURIComponent(smsMessage.replace(/%0A/g, '\n'));

      // Option 1: Try backend API if available
      try {
        const apiUrl = 'http://localhost:5000/api/orders/send-sms'; // Adjust to your backend URL
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            phone: formattedPhone, 
            message: decodedMessage, 
            orderId: order.id 
          })
        });
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            console.log('âœ… SMS sent via backend API');
            return;
          }
        }
      } catch (apiError) {
        console.log('Backend API not available, using WhatsApp fallback');
      }

      // Option 2: Fallback to WhatsApp (always works)
      const whatsappUrl = `https://wa.me/91${formattedPhone.replace(/^91/, '')}?text=${smsMessage}`;
      // Open WhatsApp in new tab as fallback
      window.open(whatsappUrl, '_blank');
      console.log('ðŸ“± Order confirmation sent via WhatsApp');
    }
  </script>
</body>
</html>
